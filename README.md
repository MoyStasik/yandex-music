# Яндекс музыка

## 1. Тема и целевая аудитория

### Тема

**Яндекс музыка** - музыкальный стриминговый сервис компании Яндекс, позволяющий слушать музыкальные композиции, их подборки, альбомы и получать персональные рекомендации. 

### Целевая аудитория
+ Количество уникальных пользователей за месяц: 24млн [2] *
+ Количество посещений приложения в месяц: 81.6 миллионов [1]
+ Среднее количество страниц за посещение: 2.58 [1]
+ Среднее количество посещений одного пользователя за месяц: 21 день
+ Среднестатистический пользователь слушает около 20-30 треков в день
+ 28% пользователей слушают подкасты хотя бы раз в месяц [3]

*- Данные за декабрь 2024 года


**Веб-трафик по странам**

![image](https://github.com/user-attachments/assets/28474299-8247-4df0-a4bc-13c64783e4a7)
Рисунок 1 - веб-трафик по странам
**Демографические показатели посещаемости сайта**

![image](https://github.com/user-attachments/assets/cad65256-a375-4c5f-811c-ef3f374f86f8)
Рисунок 2 - демографические показатели посещения сайта

### Ключевой функционал
+ Регистрация/авторизация
+ Воспроизведение музыки
+ Добавление треков в плейлист, удаление из плейлиста, хранение плейлистов
+ Поиск исполнителя, трека, альбома
+ История прослушивания треков
+ Поиск музыки по жанру
+ прослушивание подкастов

### Ключевые продуктовые решения
+ Личные рекомендации под каждого пользователя
+ Выбор музыкального настроения, для воспроизведения соответствующей музыки

### Список используемых источников
1. [https://www.similarweb.com/ru/website/music.yandex.ru](https://www.similarweb.com/ru/website/music.yandex.ru)
2. [https://www.rbc.ru/technology_and_media/02/12/2024/674db2029a79474943d5748e](https://www.rbc.ru/technology_and_media/02/12/2024/674db2029a79474943d5748e)
3. [https://vc.ru/media/187539-auditoriya-podkastov-na-yandeksmuzyke-vyrosla-v-chetyre-raza-za-god-hotya-by-raz-v-mesyac-ih-slushayut-uzhe-28-podpischikov](https://vc.ru/media/187539-auditoriya-podkastov-na-yandeksmuzyke-vyrosla-v-chetyre-raza-za-god-hotya-by-raz-v-mesyac-ih-slushayut-uzhe-28-podpischikov)


## 2. Расчет нагрузки
### Продуктовые метрики
Таблица 1 - Количество активных пользователей
<table>
    <tr>
        <th>Период</th>
        <th>Количество пользователей</th>
    </tr>
    <tr>
        <td>День</td>
        <td>тк среднее количество посещений для пользователя за месяц это 21 день, то в среднем DAU = 21/30 * 24 = 16,8млн</td>
    </tr>
    <tr>
        <td>Месяц</td>
        <td>24 миллиона</td>
    </tr>
</table>

Таблица 2 - Средний размер хранилища пользователя
<table>
    <tr>
        <th>Тип хранилища</th>
        <th>Средний объем на 1 пользователя</th>
    </tr>
    <tr>
        <td>Плейлисты</td>
        <td>Проанализируем данные о количестве плейлистов в приложениях аналогах - спотифае, по данным википедии в спотифае около 2млрд плейлистов[6], учитывая, что в спотифае около 600млн уникальных пользователей за месяц, то можем грубо оценить, что на человека приходится 4 плейлиста, для нашего приложения возьмем такую же цифру, тк привычки пользователей похожи. Сколько треков в среднем на плейлист информация нигде не приводится, поэтому был проведен анализ среди знакомых, дальше будут приведена сумма треков в плелистах каждого из опрошенных: (200 + 250 + 354 + 81 + 1090 + 342 + 100 + 1038 + 34) / 9 = 387 треков в среднем пользователи добавляют в плейлисты, на 1 плейлист приходится около 387 / 4 = 97 треков, итого 1 плейлист состоит из обложки - размер фото около 30 КБ(данные из девтулз), название плейлиста - 30 байт, хранение одной песни в виде id и другой метаинформации занимает около 0.1Кб (данные из devtools). Итого: 4*(30Кбайт + 30 байт + 0,1Кбайт) + 387*0,1Кбайт = 0,12МБ + 0,04МБ = 0,16МБ </td>
    </tr>
  <tr>
        <td>История прослушиваний</td>
        <td>Данных о количество уникальных треков, которые слушает пользователь за год в публичном доступе нет, но тк есть информация что в день среднестатистический пользователь слушает около 30 разных треков и в месяц пользователь проводит на сайте 21 из 30 дней, то можем посчитать по верхней границе, если 80 процентов треков, которые пользователь слушает не повторяются, то за год пользователь в среднем слушает 30 * 21 * 12 * 0,8 = 6048 уникальных треков. Для хранения истории необходимо 0.1Кбайт метаифнормации для 1 трека. Итого:  6048 * 0,1Кбайт = 0,6МБ</td>
    </tr>
</table>

Таблица 3 - Действия пользователей по типам
<table>
    <tr>
        <th>Тип действия</th>
        <th>Среднее количество в день</th>
    </tr>
    <tr>
        <td>Воспроизведение музыки</td>
        <td>Среднестатистический пользователь прослушивает в день около 30 треков, так как всего в сутки 16,8 млн пользователей, то всего в день прослушивается 16,8 * 30 = 504 млн</td>
    </tr>
  <tr>
        <td>Авторизация</td>
        <td>Возьмем, что авторизационный токен живет 1 месяц, тогда каждому пользователю нужно будет проходить авторизацию 1 раз в месяц, тогда кол-во авторизаций в сутки: 24 млн / 30 = 800 тыс</td>
    </tr>
    <tr>
        <td>Регистрация</td>
        <td> Месячный рост новых пользователей составляет около 1,5%, тогда в месяц новых пользователей 24млн * 0,015 = 360 000, в день получается новых пользователей: 360 000/30 = 12 000</td>
    </tr>
    <tr>
        <td>Добавление/удаление треков в/из плейлист</td>
        <td> 1,554 млн*</td>
    </tr>
    <tr>
        <td>Прослушивание треков из истории</td>
        <td> В среднем пользователь 1 раз включает трек из истории прослушиваний, всего в сутки 16,8млн юзеров, тогда всего обращений к истории треков - 16,8 * 1 = 16,8 млн </td>
    </tr>
    <tr>
        <td>Поиск исполнителя, трека, альбома</td>
        <td> Среднее количество поисков за день - 57,6 млн*</td>
    </tr>
    <tr>
        <td>Поиск треков по жанру</td>
        <td> 140 тыс*</td>
    </tr>
    <tr>
        <td>Прослушивание подкастов</td>
        <td>в месяц 28% пользователей слушают подкасты хотя бы раз[2], из этих данных можем узнать, что 24*0,28/30 = 224 000 в неделю хотя бы раз слушают подкасты</td>
    </tr>
</table>
* - данные, придуманные автором.

### Технические метрики
Битрейт песен возьмем - 128 Кбит/c.[3]

В среднем размер треков составляет 3 минуты 17 секунд[7], тогда с битрейтом 128Кбит/c размер одного трека = (197с × 128Кбит/с) / 8 / 1024 = 3,06Мб и обложка/картинка 20КБайт, итого 3,08МБ.[1]

В среднем подкасты длятся от 30 до 60минут[8], возьмем среднюю длительность 45 минут, подкасты как и треки будем хранить с битрейтом 128Кбит/c, тогда они будут занимать около 3,06МБ * 15 = 46МБ памяти + 20КБ на обложку, итого 46,02МБ на 1 подкаст.

Таблица 4 - Размер хранения в разбивке по типам данных
<table>
    <tr>
        <th>Тип хранения</th>
        <th>Размер</th>
    </tr>
    <tr>
        <td>Пользователи</td>
        <td>из таблицы 2, на одного пользователя необходимо (0,16 + 0,6) = 0,76 МБ, тогда на 24 млн пользователей 17,4ТБ</td>
    </tr>
    <tr>
        <td>Треки</td>
        <td>на 1 трек 3,08 МБ, всего 76 млнов треков, тогда для хранения всех понадобится 223,2ТБ[5]</td>
    </tr>
    <tr>
        <td>Подкасты</td>
        <td>В Яндекс музыке около 25,9тыс подкастов, тогда все подкасты будут занимать около 1,12ТБ[4]</td>
    </tr>
</table>

Таблица 5 - Сетевые метрики
<table>
    <tr>
        <th>Тип действия</th>
        <th>Пиковое потребление в течение суток, Гбит/с</th>
        <th>Суммарный суточный, Гбайт/сутки</th>
        <th>RPS (средний)</th>
        <th>RPS (пиковый)</th>
    </tr>
    <tr>
        <td>Воспроизведение музыки</td>
        <td>140 000 * 128Кбит/с = 17 920 000Кбит/c = 17,1</td>
        <td>16,8млн * 60мин * 60с * 128 Кбит/c / 2^23 = 922 852</td>
        <td>Всего 16,8 млн юзеров, тк в сутки примерно 60 минут средний пользователь слушает музыку, и запрос на новый чанк случается раз в ~ 10 секунд, те ~ 6 раз в минуту, то средний рпс будет, rps = 16,8млн * 60мин * 6 / 86400с = 70 000</td>
        <td>В пик около 140тыс пользователей слушает музыку одновременно, rps = 140 000 </td>
    </tr>
    <tr>
        <td>Авторизация</td>
        <td>14 * 16Кбайт / 2^20 = 0,0002</td>
        <td>Сетевой трафик одного запроса - 16Кбайт, тогда 800тыс * 16Кбайт / 2^20 = 12,2</td>
        <td>Всего 24млн месячных пользователей, среднестатистический пользователь заходит в музыку 21 день из 30, авторизационный токен необходимо обновлять 1 раз в месяц, тогда средний рпс = 24млн / 30 / 86400 = 9,3</td>
        <td>Пиковый рпс на авторизацию = 14</td>
    </tr>
    <tr>
        <td>Регистрация</td>
        <td>0,20 * 16Кбайт / 2^20 = 0,0000032</td>
        <td>Всего 12 000 * 16Кбайт / 2^20 = 0,18</td>
        <td>Месячный рост новых пользователей составляет около 1,5%, тогда в месяц новых пользователей 24млн * 0,015 = 360 000, в день получается 12 000 новых пользователей, тогда средний рпс будет = 12 000 / 86400 = 0,14</td>
        <td>Пик рпс = 0,20</td>
    </tr>
    <tr>
        <td>Добавление/удаление треков в/из плейлист</td>
        <td>Пиковый rps = 30 * 1,2 Кбайт / 2^20 = 0,00003</td>
        <td>Размер одного запроса - 1,2Кбайт (информация из dev tools) => всего 1,554млн * 1,2Кбайт / 2^20 = 1,78</td>
        <td>Средний рпс = 1,554млн / 86400 = 18</td>
        <td>Пиковый рпс = 30</td>
    </tr>
    <tr>
        <td>Получение треков из истории</td>
        <td>291 * 15,5Кбайт / 2^20 = 0,004</td>
        <td>16,8млн * 1 * 15,5Кбайт (информация из dev tools) / 2^20 = 248,3</td>
        <td>rps = 16,8млн * 1 / 86400 = 194</td>
        <td>Пиковый rps = 291</td>
    </tr>
    <tr>
        <td>Поиск исполнителя, трека, альбома</td>
        <td>1000 * 15Кбайт / 2^20 = 0,014</td>
        <td>57,6млн * 15Кбайт (информация из dev tools) / 2^20 = 824</td>
        <td>rps = 57,6млн / 86400 = 667</td>
        <td>Пиковый rps = 667 * 1,5 = 1000</td>
    </tr>
    <tr>
        <td>Поиск треков по жанру</td>
        <td>2,5 * 210Кбайт / 2^20 = 0,0005</td>
        <td>140тыс * 210Кбайт (информация из dev tools) / 2^20 = 28</td>
        <td>rps = 140тыс / 86400 = 1,62</td>
        <td>Пиковый rps = 2,5</td>
    </tr>
    <tr>
        <td>Прослушивание подкастов</td>
        <td>1 866 * 128Кбит/с / 2^20 = 0,23</td>
        <td>224 000 * 60мин(средняя длительность прослушивания подкастов)[2] * 60с * 128Кбит/c / 2^23 = 12 305</td>
        <td>rps = 224 000 * 60мин(средняя длительность прослушивания подкастов)[2] * 6 / 86400 = 933</td>
        <td>Пиковый рпс = 933 * 2 = 1 866</td>
    </tr>
</table>

### Список используемых источников
1. [https://yandex.ru/company/news/03-21-08-2024](https://yandex.ru/company/news/03-21-08-2024)
2. [https://vc.ru/media/187539-auditoriya-podkastov-na-yandeksmuzyke-vyrosla-v-chetyre-raza-za-god-hotya-by-raz-v-mesyac-ih-slushayut-uzhe-28-podpischikov](https://vc.ru/media/187539-auditoriya-podkastov-na-yandeksmuzyke-vyrosla-v-chetyre-raza-za-god-hotya-by-raz-v-mesyac-ih-slushayut-uzhe-28-podpischikov)
3. [https://www.amplifier.ru/news/2024/06/12/yandeks-muzyka-110624.html#:~:text=Пользователям%20будут%20доступны%20три%20опции,без%20потерь%20в%20формате%20Lossless.](https://www.amplifier.ru/news/2024/06/12/yandeks-muzyka-110624.html#:~:text=Пользователям%20будут%20доступны%20три%20опции,без%20потерь%20в%20формате%20Lossless.)
4. [https://yandex.ru/company/researches/2021/podcasts#:~:text=В%20каталоге%20Яндекс.Музыки%2011,запускалось%20более%20500%20новых%20проектов.](https://yandex.ru/company/researches/2021/podcasts#:~:text=В%20каталоге%20Яндекс.Музыки%2011,запускалось%20более%20500%20новых%20проектов.)
5. [https://ru.wikipedia.org/wiki/Яндекс_Музыка#:~:text=По%20состоянию%20на%202023%20год,пользуется%20около%2020%20млн%20человек.](https://ru.wikipedia.org/wiki/Яндекс_Музыка#:~:text=По%20состоянию%20на%202023%20год,пользуется%20около%2020%20млн%20человек.)
6. [https://ru.wikipedia.org/wiki/Spotify#:~:text=В%20настоящее%20время%20в%20«Спотифай,как%20пользователями%2C%20так%20и%20кураторами.](https://ru.wikipedia.org/wiki/Spotify#:~:text=В%20настоящее%20время%20в%20«Спотифай,как%20пользователями%2C%20так%20и%20кураторами.)
7. [https://daily.afisha.ru/news/58899-srednyaya-dlina-pesen-s-godami-sokraschaetsya/#](https://daily.afisha.ru/news/58899-srednyaya-dlina-pesen-s-godami-sokraschaetsya/#)
8. [https://roistat.com/rublog/podkast/#:~:text=В%20среднем%20подкасты%20длятся%20от%2030%20минут%20до%201%20часа.](https://roistat.com/rublog/podkast/#:~:text=В%20среднем%20подкасты%20длятся%20от%2030%20минут%20до%201%20часа.)

## 3. Глобальная балансировка нагрузки
### Функциональное разбиение по доменам
Тк сервис связан с большим количеством загружаемого контента, то я решил разбить все на 2 домена - первый будет служить, как раздача статического контента: музыки, подкастов, обложек, а второй домен будет для апишки:
+ cdn-music.yandex.ru - данный домен будет использоваться для раздачи музыки, подкастов, обложек
+ music.yandex.ru - данный домент будет служить для действий с апи - авторизация/регистрация, добавление/удаление в/из плейлиста и др. 

### Расположение ДЦ
Учитывая веб трафик пользователей яндекс музыки на рисунке 3 и учитывая магистральные сети связи в России[1], можно выделить следующие города с ДЦ:
+ Москва
+ Санкт-Петербург
+ Краснодар
+ Казань
+ Новосибирск
+ Хабаровск
![image](https://github.com/user-attachments/assets/28474299-8247-4df0-a4bc-13c64783e4a7)
Рисунок 3 - веб трафик по странам

**Пояснение:**

В Москву и Санкт-Петербург можно поставить cdn, чтобы раздавали статику, суммарный средний рпс на музыку, подкасты = 70000 + 993 = 70993, предлагаю поставить 3 ДЦ в Москву и 3 ДЦ в Санкт-Петербург, что поможет в отказоустойчивости, если один ДЦ упадет, другие смогут выдержать входящий трафик, также количество ДЦ обусловлено большой нагрузкой на получение статического контента.
Остальные ДЦ будут не такими нагруженными и будет достаточно по 1 ДЦ в каждом городе, даже если ДЦ в ближайшем городе выйдет из строя, другой регион сможет выдержать нагрузку

Тк мало пользователей приходится на Нидерланды и Беларусь, то нет смысла для них выделять отдельные ДЦ, поэтому трафик в этих странах будет идти в Москву. По той же причине нет смысла ставить ДЦ в Казахстан/Узбекистан их трафик будет направляться в Новосибирск/Казань

### Расчет распределение запросов из секции "Расчет нагрузки" по типам запросов по датацентрам
Для расчета распределения запросов воспользуемся картой плотности России.
![image](https://github.com/user-attachments/assets/c85603c8-1b6f-4a40-acf3-6b10065e61ca)



+ cdn-music.yandex.ru - наибольшая нагрузка будет от запросов на этот домен, тк он будет отвечать за раздачу статики на клиенты
+ music.yandex.ru - запросы на этом домене будут отвечать за запросы к апи

запросы к апи требуют в среднем (9,3 + 0,14 + 18 + 194 + 667 + 1,62) = 890 рпс из этого можно построить таблицу 6.

Тк около 70 процентов населения России расположены в европейской части, то сделаем следующее распределение: средний рпс * 0,7 поделим на 4 города Москва, Санкт-Петербург, Краснодар, Казань. В Мск и Питере больше всего ДЦ и потенциальная будет испытываться наибольшая нагрузка на эти ДЦ, можем равномерно распределить нагрузку на каждый отдельный ДЦ. Всего на европейскую часть 3 + 3 + 1 + 1 = 8 ДЦ, тогда каждый отдельный ДЦ будет обрабатывать около 70% / 8 = 8,75% запросов пользователей.

Казань также будет захватывать часть трафика Зауралья(Екатеринбург, Уфа и близлижайшие), поэтому на этот ДЦ будет чуть больше нагрузки, возьмем 13,75% запросов.

Оставшиеся 25% Азиатской части будут покрывать ДЦ в Новсибирске и Хабаровске, для них сделаем равную нагруженность 25% / 2 = 12,5% запросов пользователей.

Таблица 6 - Распределение запросов на домен music.yandex.ru
<table>
    <tr>
        <th>Датацентры</th>
        <th>Средний рпс</th>
    </tr>
    <tr>
        <td>Москва на 3 ДЦ</td>
        <td>890(всего средний рпс) * ( 0,0875 * 3(ДЦ) ) = 233,6</td>
    </tr>
    <tr>
        <td>Санкт-Петербург на 3 ДЦ</td>
        <td>890(всего средний рпс) * ( 0,0875 * 3(ДЦ) ) = 233,6</td>
    </tr>
    <tr>
        <td>Краснодар</td>
        <td>890(всего средний рпс) * ( 0,0875 * 1(ДЦ) ) = 77,9</td>
    </tr>
    <tr>
        <td>Казань</td>
        <td>890(всего средний рпс) * ( 0,1375 * 1(ДЦ) ) = 122,375</td>
    </tr>
    <tr>
        <td>Новосибирск</td>
        <td>890(всего средний рпс) * ( 0,1225 * 1(ДЦ) ) = 109</td>
    </tr>
    <tr>
        <td>Хабаровск</td>
        <td>890(всего средний рпс) * ( 0,1225 * 1(ДЦ) ) = 109</td>
    </tr>
</table>

Воспроизведение музыки и подкастов требует (70 000 + 993) = 70 993 запроса в секунду, из этого можно построить таблицу 7.

Таблица 7 - Распределение запросов на домен cdn-music.yandex.ru
<table>
    <tr>
        <th>Датацентры</th>
        <th>Средний рпс</th>
    </tr>
    <tr>
        <td>Москва на 1 ДЦ</td>
        <td>70 993 / 6 = 11 832</td>
    </tr>
    <tr>
        <td>Санкт-Петербург на 1 ДЦ</td>
        <td>70 993 / 6 = 11 832</td>
    </tr>
</table>

### Схема DNS балансировки
Тк ДЦ географически удалены друг от друга, будет логично использовать Geo-based DNS. Однако из-за того, что почти все ДЦ расположены в России могут возникать проблемы с резолвингом. Поэтому в данном случае решил воспользоваться Latency-based DNS, тк при загрузке музыки необходима скорость, обеспечивающаяся за счет наименьшего latency. Этот вид балансировки будет использоваться для запросов к апи, т.е. при обращении к домену music.yandex.ru

### Схема Anycast балансировки
Тк в Москве и Санкт-Петербурге будет находиться статика, будет разумно для балансировки трафика использовать BGP Anycast, объединив ДЦ в Москве и Питере под одним ip. Этот вид балансировки будет использоваться для запросов к cdn, т.е. при обращении к домену cdn-music.yandex.ru 

### Список используемых источников
1. [https://www.comnews.ru/content/230456/2023-12-20/2023-w51/1180/magistralnye-seti-svyazi-rossii-2023#map-section](https://www.comnews.ru/content/230456/2023-12-20/2023-w51/1180/magistralnye-seti-svyazi-rossii-2023#map-section)


## 4. Локальная балансировка нагрузки
### Cхемы балансировки для входящих и внутренних запросов
+ Буду использовать Kubernetes кластеры, тк они подходят и для балансировки запросов, и для оркестрации;
+ Для балансировки внешних запросов будет использоваться Nginx, как L7 балансировщик;
+ До Nginx трафик будет балансироваться с помощью LVS via Direct Routing, для этого хосты должны быть в одной физической сетке;
+ Nginx работает как HTTP Reverse Proxy балансировщик на уровне L7.

### Схема отказоустойчивости
+ Для обеспечения отказоустойчивости будет использоваться k8s и Auto-scaling. Тем самым Service discovery будет реализован за счёт оркестрации. Система оркестрации при создании контейнера вносит экземпляр в реестр после успешного прохождение readiness пробы. Так же с помощью readiness-проб обеспечивается исключение из кластера упавших подов; 
+ Использование Keepalived;
+ К тому же, периодически может проводиться проверка работоспособности сервера посредством отсылания на него базовых L7 health checks;
+ Следим за нагрузкой балансировщиков, макс нагрузка 80 процентов, если будет больше, то будем увеличивать их количество, если какая то железка умрет, то трафик перераспределиться по остальным, за счет того, что будет запас по нагрузке на каждом балансировщике, будет время восстановить/купить новую железку
### Нагрузка по терминации SSL
В среднем SSL handshake занимает 3ms[1]. Мы будем использовать session cache. Необходимо рассчитать, какое количество запросов будут кешироваться:
(70000 + 194 + 667 + 1,62 + 11200) / (70000 + 9,3 + 0,14 + 18 + 194 + 667 + 1,62 + 11200) = 99 % - запросов попадает в кеш.

Суммарный пиковый рпс = (140000 + 14 + 0,20 + 30 + 291 + 1000 + 2,5 + 22400) = 163 737, тогда выходит, что 163 737 * (1 - 0,99) = 1 637 запросов не попадают в кеш, на обработку ssl уйдет 1637 * 3ms = 4,9s процессорного времени
### Использование источников
1. [https://www.ibm.com/docs/en/cics-ts/6.x?topic=performance-ssl-handshake-overhead](https://www.ibm.com/docs/en/cics-ts/6.x?topic=performance-ssl-handshake-overhead)


## 5. Логическая схема БД

### Таблица, поля и связи между ними

На рисунке ниже представлена диаграмма отношений между выделеннными мной таблицами.

<img width="853" alt="image" src="https://github.com/user-attachments/assets/ba96e008-5373-4be4-8946-a6ac924e2815" />

Ниже представлено описание всех таблиц.

<br>
Таблица 8 - Описание выделенных таблиц
<table>
    <tr>
        <th>Имя таблицы</th>
        <th>Поля таблицы</th>
        <th>Краткое описание таблицы</th>
    </tr>
    <tr>
        <td>Session</td>
        <td>id - уникальный хеш сессии<br>
            user_id - id пользователя, которому принадлежит сессия<br>
            expires - дата, когда истечет сессия<br>
            created_at - дата, когда сессия была создана</td>
        <td>В таблице хранятся сессии пользователей</td>
    </tr>
    <tr>
        <td>Users</td>
        <td>id - уникальный id пользователя<br>
        username - никнейм пользователя<br>
        password - зашифрованный пароль пользователя<br>
        img_path - путь на аватарку пользователя, хранящуюся в s3<br>
        created_at - дата создания пользователя</td>
        <td>В данной таблице хранится инофрмация о пользователях</td>
    </tr>
    <tr>
        <td>Authors</td>
        <td>id - уникальный id автора<br>
        nickname - никнейм автора<br>
        img_path - путь на фото автора, хранящееся в s3<br>
        created_at - дата создания записи об авторе</td>
        <td>Данная таблица хранит информацию об исполнителях</td>
    </tr>
    <tr>
        <td>Genres</td>
        <td>id - уникальный id жанра<br>
        genre_name - наименование жанра</td>
        <td>Таблица описывает музыкальные жанры</td>
    </tr>
    <tr>
        <td>Songs</td>
        <td>id - уникальный id песни<br>
        author_id - id автора, которому принадлежит песня<br>
        genre_id - id жанра, к которому принадлежит песня<br>
        song_file_path - путь до файла с песней, хранящегося в s3<br>
        created_at - дата создания записи о песни</td>
        <td>Данная таблица описывает сущность песни</td>
    </tr>
    <tr>
        <td>Playlists</td>
        <td>id - уникальный id плейлиста<br>
        user_id - id пользователя, которому принадлежит плейлист<br>
        song_id - id песни, которая находится в плейлисте<br>
        img_path - путь до файла с картинкой плейлиста, хранящегося в s3<br>
        playlist_name - название плейлиста<br>
        created_at - дата создания плейлиста</td>
        <td>Таблица хранит информацию о плейлистах</td>
    </tr>
    <tr>
        <td>History</td>
        <td>id - уникальный id истории<br>
        user_id - id пользователя, которому принадлежит история<br>
        song_id - id песни, которая находится в истории<br>
        created_at - дата создания записи об истории<br>
        updated_at - дата обновления истории</td>
        <td>Таблица хранит историю прослушивания треков каждого пользователя</td>
    </tr>
    <tr>
        <td>Thematics</td>
        <td>id - уникальный id тематики для подкаста<br>
        thematic_name - наименование тематики</td>
        <td>Таблица описывает тематики подкастов</td>
    </tr>
    <tr>
        <td>Podcasts</td>
        <td>id - уникальный id плейлиста<br>
        author_id - id пользователя, которому принадлежит плейлист<br>
        thematic_id - id песни, которая находится в плейлисте<br>
        podcast_name - путь до файла с картинкой плейлиста, хранящегося в s3<br>
        description - название плейлиста<br>
        podcast_file_path - путь до файла с подкастом, хранящегося в s3<br>    
        created_at - дата создания плейлиста</td>
        <td>Таблица хранит информацию о подкастах</td>
    </tr>
</table>

### Размеры данных и нагрузки на чтение/запись

Ниже представлена оценочная информация о данных для каждой таблицы.

<br>
Таблица 9 - Размеры данных каждой таблицы
<table>
    <tr>
        <th>Название таблицы</th>
        <th>Размер данных таблицы</th>
    </tr>
    <tr>
        <td>Session</td>
        <td>Допустим, длина хеша - 40 символов. Тогда размер данных: 24 млн * (40байт + 8байт + 8байт + 8байт) = 1,43Гб</td>
    </tr>
    <tr>
        <td>Users</td>
        <td>Для id пользователей будем использовать id размеров 8 байт, username пользователя в среднем состоит из 10 символов, захешированный пароль из 32 символов, пусть путь до аватарки пользователя состоит из 25 символов, дата создания занимает 8 байт. Итого 24млн * (8байт + 10байт + 32байт + 25байт + 8байт) = 1,86Гб</td>
    </tr>
    <tr>
        <td>Authors</td>
        <td>по данным спотифая, на платформе около 11 млн артистов[1], для Яндекс музыки возьмем 10 млн артистов, 10млн * (8 + 10 + 25 + 8)байт = 0,47Гбайт</td>
    </tr>
    <tr>
        <td>Genres</td>
        <td>Данные по количеству жанров представленных в Яндекс музыки я не нашел, однако в статистике по спотифаю написано, что их представлено более 5000[2], возьмем это значение для Яндекс музыки. Среднее количество символов для жанра - 8. Итого 5000 * (8 + 8)байт = 0,08Мб</td>
    </tr>
    <tr>
        <td>Songs</td>
        <td>Раннее мы выяснили что в Яндекс музыки представлено около 76млн треков, длина пути до файла в среднем будет занимать около 25 символов. Итого размер хранилища: 76млн * (8 + 8 + 8 + 25 + 8)байт = 4,03Гбайт</td>
    </tr>
    <tr>
        <td>Playlists</td>
        <td>Раннее мы выяснили, что на человека приходится около 4 плейлистов, тогда всего около 24млн * 4 = 96млн плейлистов, длина пути до картинки занимает около 25 символов, средняя длина названия плейлиста - 10 символов. Посчитаем размер хранилища: 96млн * (8 + 8 + 8 + 25 + 10 + 8)байт = 5,28Гбайт</td>
    </tr>
    <tr>
        <td>History</td>
        <td>Раннее мы выяснили, что около 6048 треков хранятся в истории прослушиваний, тогда будет 6048 разных song_id, рассчитаем размер хранилища: 24млн * (8 + 8 + 6048*8 + 8 + 8)байт = 1,06Тб</td>
    </tr>
    <tr>
        <td>Thematics</td>
        <td>Посчитаем размер таблицы, при 30 разных жанров[3] и при 10 символов в среднем на тематику. 30 * (8 + 10) байт = 0,001Мбайт</td>
    </tr>
    <tr>
        <td>Podcasts</td>
        <td>Раннее мы расчитали, что всего в Яндекс музыки представлено около 25,9тыс подкастов, название подкастов в среднем занимает около 15 символов, описание подкаста в среднем состоит из 40 слов - 320 символов. 25,9тыс * (8 + 8 + 8 + 15 + 40 + 25 + 8) = 0,003Гб</td>
    </tr>
    <tr>
        <td>Итого</td>
        <td>1,073Тб</td>
    </tr>
</table>

Оценим еще размер хранилищ с файлами треков и подкастов.

Таблица 10 - Размеры хранилищ
<table>
    <tr>
        <th>Тип хранения</th>
        <th>Размер</th>
    </tr>
    <tr>
        <td>Треки</td>
        <td>223,2ТБ</td>
    </tr>
    <tr>
        <td>Подкасты</td>
        <td>1,12ТБ</td>
    </tr>
</table>

Расчет данных взят из таблицы 4.

Посчитаем нагрузку на чтение и запись, смотреть таблицу 11.

Таблица 11 - Нагрузка на чтение и на запись
<table>
    <tr>
        <th>Название таблицы</th>
        <th>Нагрузка на чтение</th>
        <th>Нагрузка на запись</th>
    </tr>
    <tr>
        <td>Session</td>
        <td>Сессия проверяется при каждом запросе - рпс = 82 090(средний суммарный рпс)</td>
        <td>В месяц 24млн * 2 = 48млн(создать/удалить). rps = 18,5</td>
    </tr>
    <tr>
        <td>Users</td>
        <td></td>
        <td></td>
    </tr>
    <tr>
        <td>Authors</td>
        <td></td>
        <td></td>
    </tr>
    <tr>
        <td>Genres</td>
        <td></td>
        <td></td>
    </tr>
    <tr>
        <td>Songs</td>
        <td></td>
        <td></td>
    </tr>
    <tr>
        <td>Playlists</td>
        <td></td>
        <td></td>
    </tr>
    <tr>
        <td>History</td>
        <td></td>
        <td></td>
    </tr>
    <tr>
        <td>Thematics</td>
        <td></td>
        <td></td>
    </tr>
    <tr>
        <td>Podcasts</td>
        <td></td>
        <td></td>
    </tr>
    <tr>
        <td>Итого</td>
        <td></td>
        <td></td>
    </tr>
</table>

Ниже представлены нагрузки на хранилища.

Таблица 11 - Нагрузка на чтение и на запись
<table>
    <tr>
        <th>Название таблицы</th>
        <th>Нагрузка на чтение</th>
        <th>Нагрузка на запись</th>
    </tr>
    <tr>
        <td>Треки</td>
        <td>Сессия проверяется при каждом запросе - рпс = 82 090(средний суммарный рпс)</td>
        <td>В месяц 24млн * 2 = 48млн(создать/удалить). rps = 18,5</td>
    </tr>
    <tr>
        <td>Подкасты</td>
        <td></td>
        <td></td>
    </tr>
    <tr>
        <td>Аватарки пользователей</td>
        <td></td>
        <td></td>
    </tr>
    <tr>
        <td>Итого</td>
        <td></td>
        <td></td>
    </tr>
</table>

### Используемые источники

1. https://www-searchlogistics-com.translate.goog/learn/statistics/spotify-statistics/?_x_tr_sl=en&_x_tr_tl=ru&_x_tr_hl=ru&_x_tr_pto=rq#:~:text=Key%20Spotify%20Statistics,-Despite%20not%20being&text=Spotify%20has%2082%20million%20songs,creators%20on%20the%20Spotify%20platform
2. https://dtf.ru/music/668422-kak-naiti-svoi-v-5000-podkapotnyh-zhanrov-spotify
